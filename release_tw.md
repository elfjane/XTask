# 更新日誌

所有 XTask 所有專案的重大變更都將記錄在此文件中。

## [2026-01-19] - 已完成任務管理功能增強
- **UI/UX 優化**:
  - 將任務管理模組中的「類別」統一更名為「級別」，以更精確地描述任務優先權。
  - **視覺強化**: 任務列表中的「級別」欄位現在支援動態背景色：級別 2 (重要) 顯示為**黃色**，級別 3 (優先) 顯示為**紅色**。
  - 在「添加任務」彈窗中新增「級別」欄位，允許用戶在建立任務時直接設定優先度。
  - 同步更新排序選單中的「按級別」標籤。
- **問題修復**:
  - 修復了大頭照上傳後顯示 404 的問題。在 Nuxt 配置中增加了 `/storage` 的代理 (Proxy)，並在 Docker Nginx 配置中增加了 `alias` 指令，確保在本地開發與 Docker 環境下都能正確讀取後端伺服器的靜態檔案。
- **新功能**:
  - **大頭照上傳與裁剪**: 用戶現在可以在「個人設定」頁面中更換大頭照。支援上傳時手動裁剪調整，系統會自動轉換為 512x512 高清規格。
  - **自定義拖拽排序**: 用戶現在可以在任務列表中點擊整列的空白區域直接進行上下拖拽調整順序（無需特定圖示）。系統會自動記憶排序位置，即使重新整理頁面也會保留最後的排列順序。
  - 管理員與審核者現在可以在「已完成任務」頁面中，將已通過或已失敗的任務「退回未送審」並設為「執行中」狀態。
  - **UI 優化**: 「編輯」與「退回未送審」按鈕現在僅在「已完成任務」頁面模式下的詳情彈窗顯示，確保操作邏輯清晰並防止在其他頁面誤操作。
- **後端優化**:
  - 修復「已完成任務」列表會顯示「送審中」任務的問題。
  - 現在「已完成」列表僅會顯示已通過（approved）或已完成（finished）且非送審中的任務。
  - 退回任務時，系統會自動清除審核時間、審核者及通過/失敗時間等紀錄訊息。
  - 同步更新統計數據邏輯，確保點數統計僅包含已結案的任務。

## [2026-01-14 17:15] - 任務狀態快速切換
- **前端優化**:
  - 實作任務列表中的一鍵切換狀態功能。
  - 用戶現在可以點擊狀態標籤叫出下拉選單，直接變更任務狀態（例：執行中、未執行、閒置）。
  - 後端整合沿用強大的 `PUT /tasks/{task}` 接口，完整支援自動送審等副作用處理。
- **後端優化**:
  - 優化 `AccessDeniedHttpException` 的異常處理邏輯，現在會返回清晰的 JSON 403 Forbidden 回應，而非詳細的除錯堆疊追蹤。
  - 更新 `PUT /tasks/{task}` 的 OpenAPI 規格，補充 403 未授權回應的說明。

## [2026-01-14 10:50] - Excel 匯入狀態處理優化
- **後端功能優化**:
  - 優化 Excel 任務匯入邏輯，現在會根據 Excel 中的「狀態」欄位決定任務狀態。
  - 只有在 Excel 狀態標記為「已完成」時，才會同步將審核狀態改為「已通過」。
  - 支援多種狀態文字映射（如：已完成、執行中、未執行、待測試、已取消等），確保匯入資料的準確性。

## [2026-01-14 11:10] - 效能與 UI 優化
- **效能優化**:
  - 新增資料庫索引（Index）於任務表常用的篩選與排序欄位，大幅提升查詢速度。
  - 優化 API Eager Loading 邏輯，在列表視圖僅載入「最新備註（latestRemark）」，減少原本載入全部備註導致的記憶體耗損與傳輸延遲。
- **前端 UI 調整**:
  - 調整「完成任務」列表的欄位順序，將「審核狀態」、「審核者」及「審核時間」移至「備註」欄位之後，優化閱讀動線。
  - 移除登入頁面的測試帳號資訊。
  - 任務點數預設值調整為 1.0，並支援最小 0 點（以 0.5 為單位）。

## [2026-01-13 18:25] - Docker 支援
- **基礎設施**:
  - 在根目錄新增 `docker-compose.yml` 支援全站容器化部署。
  - 為 Laravel API 建立 `backend/Dockerfile` 與 `backend/.docker/nginx/default.conf`。
  - 為 Nuxt 4 前端建立 `frontend/Dockerfile`。
  - 整合 MySQL 8.0 為 Docker 預設資料庫服務。

## [2026-01-13 17:50] - Markdown 支援與任務功能強化
- **Markdown 語法支援**:
  - 安裝 `marked` 代碼庫用於 Markdown 解析。
  - 建立 `MarkdownViewer.vue` 組件，確保安全渲染 Markdown 並自動在新分頁開啟連結。
  - **自動識別連結圖示**: 新增自動偵測服務圖示功能（支援 GitLab, Asana, Google Docs/Sheets/Slides, GitHub, Slack, YouTube 等），在連結文字前自動顯示對應 Icon。
  - 任務面板的「備註」、「對話紀錄」與「產出連結」現在全面支援 Markdown。
  - 排程面板的「備註」與「留言紀錄」同樣支援 Markdown。
  - 在表單輸入框標籤旁新增 "Markdown" 提示標籤。
- **後端功能強化**:
  - 將 `output_url` 欄位類型從 `string` 改為 `text`，取消 255 字元限制以支援長網址。
  - 將任務日期欄位（發佈、起始、預計完成、實際完成）改為 `timestamp` 類型以提升精度。
  - 優化 `review_status` 驗證邏輯，解決因 null 值導致的更新報錯問題。
- **前端介面優化**:
  - 擴充「任務編輯」彈窗，補齊專案、項目、部門、相關人員與產出連結等欄位修改功能。
  - 將「產出連結」輸入框改為 `textarea`，方便編輯 Markdown 內容。
  - 優化「完成任務」列表，補齊日期格式化與 Markdown 渲染顯示。
  - 修正儲存格排版，防止長連結撐開表格導致跑版。
- **Excel 匯入功能升級**:
  - 實作全欄位超連結掃描，自動從 Excel 單元格屬性中提取內嵌連結。
  - 新增 `autoConvertLinksToMarkdown` 輔助工具，自動將文字中的原始網址轉為 Markdown 格式。
  - 修正「項目」與「部門」欄位的匯入對應與空白過濾邏輯。
- **錯誤修正**:
  - 補齊缺少的 `schedules/{schedule}/memos` 路由，並修正相關單元測試。


## [2026-01-13 15:50] - Excel 任務匯入
- **後端**:
  - 實作 `TaskController@import` 使用 `phpoffice/phpspreadsheet` 批次從 Excel 檔案匯入任務。
  - 自動從「工作」欄位 (H 欄) 提取內嵌超連結到「備註說明」（置於備註最上方並換行）。
  - 根據匯入資料自動設定審核成功狀態與審核相關資訊。
- **前端**:
  - 為管理員新增「任務匯入」頁面。
  - 實作具備拖放與即時狀態顯示的高品質檔案上傳介面。
  - 新增匯入工作流的多國語系支援。

## [2026-01-13 13:00] - 任務審核流程
- **後端 (Backend)**:
  - 任務表新增 `review_status` 欄位 (unsubmitted, submitted, approved, failed)。
  - 實作自動送審邏輯：當任務狀態設為 `finished` 時自動轉為 `submitted`。
  - `TaskController@index` 新增審核狀態過濾功能。
  - 更新 `TaskPolicy` 允許審核者 (Auditor) 審核任務及執行人員 (Assignee) 更新自己的任務。
  - 新增 `TaskReviewApiTest` 測試。
- **前端 (Frontend)**:
  - `tasks.vue` 新增「送審中任務」模式（審核者、管理者、系統管理員可見）。
  - 實作審核時的唯讀詳情檢視。
  - 新增審核者專用的「通過」、「未通過」操作按鈕。
  - 主任務列表自動過濾已審核通過或失敗的任務。

## [2026-01-12 14:35] - 任務與排程詳情功能增強
- **後端 (Backend)**:
  - 在 `ScheduleController` 與 `TaskController` 中支援 `show` 與 `update` 方法。
  - 更新 API 路由以支援個別任務與排程的獲取及完整資料更新。
  - 留言/備註功能現在預設以 `created_at` 進行**正序 (ASC)** 排列。
- **前端 (Frontend)**:
  - **詳情彈窗**: 點擊任務（項目/工作內容）或排程標題時，會跳出完整的詳情檢視彈窗。
  - **編輯功能**: 在詳情彈窗中整合了「編輯」模式，支援修改所有欄位（包含日期與狀態）。
  - **留言/備註系統**:
    - 列表頁面現在**僅顯示最後一則**留言，保持介面簡潔。
    - 詳情彈窗內可查看完整的留言歷史紀錄，並新增發言時間顯示。
  - **實際日期**: 於排程中新增「實際開始日期」與「實際結束日期」的顯示與編輯功能。
  - **UI/UX 優化**: 統一任務與排程的點擊行為，並優化了編輯表單的響應式佈局。

## [2026-01-09 16:50] - 排程與任務功能增強與優化
- **後端 (Backend)**:
  - 建立 `ScheduleMemoController` 以支援排程的留言板式備註。
  - 新增 `POST /api/schedules/{schedule}/memos` 接口。
  - 新增 `POST /api/tasks/{task}/remarks` 接口與 `TaskRemarkController`。
  - 新增 `PUT /api/tasks/{task}` 接口，允許更新任務內容（例如變更執行人員）。
  - 新增 `GET /api/projects` 接口與 `ProjectController` 用於獲取專案列表。
  - 新增 `GET /api/departments` 接口與 `DepartmentController` 用於獲取部門列表。
  - 更新 `ScheduleController@store`，將狀態預設為 `in_progress` ("未執行")。
  - 更新 `TaskController@store`，將 `status` 預設為 `in progress` ("未執行")，`level` 預設為 `1` ("一般")。
  - 更新 `openapi.yaml` 並加入完整測試 (`ScheduleMemoApiTest`, `TaskApiTest`)。
- **Frontend**:
  - 更新 `schedules.vue`，從建立表單中移除「實際開始」、「實際結束」與「狀態」。
  - 更新 `tasks.vue`，從建立表單中移除「狀態」與「類別」，改用後端預設值。
  - **執行人員更新**: 實作點擊即改功能，在任務列表中直接點擊執行人員即可變更指派。
  - **專案與部門**: 將「專案」改為下拉選單，並新增「部門」選單及連動執行人員的自動帶入功能。
  - **留言板**: 將任務「備註」改為互動式留言板組件，支援即時留言。
  - **修正**: 同步 `en.json` 與 `zh-TW.json` 補齊缺失的狀態翻譯。
  - **UI 優化**: 修正任務列表中執行人員資訊的垂直置中對齊問題。

## [2026-01-09 14:15] - 角色權限控制 (RBAC) 系統
- **後端**:
  - 實作 5 種角色：`admin`, `manager`, `task_user`, `executor`, `auditor`。
  - 新增 `User`, `Department`, `Project`, `Schedule`, 與 `Task` 的 Laravel Policies。
  - 更新 `CheckRole` 中間件以支援多角色驗證。
  - 在 Controller 中強制執行「先驗證後校驗」以增進安全性。
  - Seed 預設所有角色的用戶。
- **前端**:
  - 增強 `useAuth` 加入 `hasRole` 與 `can` 權限輔助工具。
  - 實作根據角色的動態 UI 渲染（隱藏/顯示按鈕與導覽項）。
  - 更新 `admin` 中間件以支援多角色授權。

## [2026-01-09 11:45] - 管理介面與功能
- **後端**:
  - **Schema**: 建立 `departments` 與 `projects` 表；在 `users` 表加入角色、狀態等欄位。
  - **API**: 實作用戶、專案、部門的 CRUD 管理接口。
  - **安全性**: 加入角色檢查並阻擋凍結帳戶登入。
  - [修正] 解決重新整理跳轉登入問題。
  - [修正] 修復 Admin 介面 `apiBase` 未定義錯誤。
  - [修正] 補全 `zh-TW` 缺失翻譯。
  - [功能] 實作用戶凍結功能。
  - **測試**: 加入所有 Admin API 的功能測試。
  - **Seeding**: 加入預設部門與專案資料。
- **前端**:
  - **佈局**: 建立帶側邊欄的 `admin` 佈局。
  - **帳號管理**: 實作用戶列表、建立、編輯與凍結功能。
  - **資源管理**: 實作專案與部門管理模組。
  - **i18n**: 完成管理介面的完整中英文翻譯。
  - **UI/UX**: 優化導覽列連結與語系切換位置（移至個人設定頁）。

## [2026-01-08 17:30] - 用戶註冊功能與開關控制
- **後端**: 加入 `ALLOW_REGISTRATION` 控制註冊功能之開關。
- **前端**: 根據後端設定顯示或隱藏註冊連結。
- **功能**: 
  - 實作個人資料頁面 (`/profile`)。
  - 檢視與編輯個人資訊 (姓名、信箱)。
  - 變更密碼功能。
- **修正**: 優化驗證中間件，解決註冊後的狀態同步問題。

## [2026-01-08 17:00] - 後端穩定性與單元測試
- **修正**: 強制 API 路由在未驗證時回傳 JSON。
- **測試**: 加入 Auth, Profile, Schedules, Tasks, Users 的完整功能測試。
- **測試**: 建立所有核心模型的 Factory。
- **文件**: 同步 `openapi.yaml` 與 API 實作。

## [2026-01-08 16:30] - 任務管理整合
- **前端**: 實作響應式 Tasks 頁面。
  - 電腦版表格視圖 (Table View)。
  - 手機版卡片視圖 (Card View)。
  - 新增任務選擇器與表單校驗。
- **後端**: 實作 `TaskController` 及其關係預載。

## [2026-01-08 15:35] - 頁面載入特效
- **UI/UX**: 加入 `NuxtLoadingIndicator` 並實作頁面與佈局間的淡入淡出特效。

## [2026-01-08 15:30] - 排程頁面多國語系支持
- **i18n**: 整合排程頁面所有標籤與狀態的翻譯。

## [2026-01-08 15:15] - 響應式 UI 與 Nuxt 4 升級
- **新功能**: 新增響應式排程頁。
- **資料庫**: 為 `schedules` 加上 `memo` 欄位。
- **遷移**: 將前端專案結構升級至 Nuxt 4 (移動至 `app/`)。

## [2026-01-07] - 初始專案搭建
- **基礎**: Nuxt 與 Laravel 基礎架構搭建。
- **身分驗證**: 基礎用戶登入機制實作。
